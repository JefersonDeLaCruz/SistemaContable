<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" data-theme="corporate">

<head th:replace="~{layout :: head}">
  <link rel="stylesheet" th:href="@{/css/output.css}"/>
  <link rel="stylesheet" th:href="@{/css/style.css}"/>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="stylesheet" href="@{/css/output.css}">
  <!-- <title th:text="${titulo}">Dashboard</title> -->
</head>

<body>

  <div class="drawer">
    <input id="my-drawer-3" type="checkbox" class="drawer-toggle" />
    <div class="drawer-content flex flex-col">
      <!-- Navbar -->
      <div class="navbar bg-base-300 w-full">
        <div class="flex-none">
          <label for="my-drawer-3" aria-label="open sidebar" class="btn btn-square btn-ghost">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                 class="inline-block h-6 w-6 stroke-current">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </label>
        </div>
        <div class="mx-2 flex-1 px-2">Dashboard</div>
        <div class="hidden flex-none lg:block">
          <ul class="menu menu-horizontal">
            <li><a>Perfil</a></li>
            <li><a>Configuración</a></li>
          </ul>
        </div>
      </div>

      <!-- CONTENIDO PRINCIPAL PERSONALIZADO POR ROL -->
      <div class="p-6">

        <!-- Header con saludo + reloj -->
        <div class="mb-8 flex items-center justify-between gap-4">
          <div>
            <h1 class="text-3xl font-bold mb-2">
              ¡Bienvenido, <span th:text="${usuario.username}">admin</span>!
            </h1>
          </div>
          <div class="text-right">
            <div id="reloj-hora" class="text-3xl font-bold tabular-nums">--:--:--</div>
            <div id="reloj-fecha" class="text-sm opacity-70">—</div>
          </div>
        </div>

        <!-- DASHBOARD PARA ADMINISTRADOR -->
        <div th:if="${usuario.role == 'ADMIN'} ">

          <!-- ======================= KPIs (franja superior) ======================= -->
          <div class="px-6 pt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
            <div class="stat bg-base-200 rounded-xl">
              <div class="stat-title">Partidas del mes</div>
              <div class="stat-value text-info">128</div>
              <div class="stat-desc">Última actualización: 10:20</div>
            </div>
            <div class="stat bg-base-200 rounded-xl">
              <div class="stat-title">Ingreso mensual</div>
              <div class="stat-value text-success">$42,350.75</div>
              <div class="stat-desc">Sep 2025</div>
            </div>
            <div class="stat bg-base-200 rounded-xl">
              <div class="stat-title">Ingreso diario</div>
              <div class="stat-value text-success">$3,125.40</div>
              <div class="stat-desc">Hoy</div>
            </div>
            <div class="stat bg-base-200 rounded-xl">
              <div class="stat-title">Mayor movimiento (hoy)</div>
              <div class="stat-value text-success">$7,890.00</div>
              <div class="stat-desc">1101 - Caja</div>
            </div>
            <div class="stat bg-base-200 rounded-xl">
              <div class="stat-title">Usuarios activos</div>
              <div class="stat-value text-success">12</div>
            </div>
          </div>
          <!-- ===================== /KPIs ===================== -->

          <!-- ====== FILA VISUAL (sin librerías) ====== -->
          <div class="px-6 mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Partidas por día (semana actual) -->
            <div class="card bg-base-100 shadow">
              <div class="card-body">
                <div class="flex items-center justify-between">
                  <h3 class="card-title">Partidas registradas esta semana</h3>
                </div>

                <div class="mt-2 space-y-3" data-group="semana">
                  <div class="grid grid-cols-12 gap-3 items-center">
                    <div class="col-span-2 text-sm">Lunes</div>
                    <div class="col-span-9">
                      <progress class="progress progress-success w-full" value="0" max="100" data-val="12"></progress>
                    </div>
                    <div class="col-span-1 text-right text-sm font-medium" data-out>12</div>
                  </div>
                  <div class="grid grid-cols-12 gap-3 items-center">
                    <div class="col-span-2 text-sm">Martes</div>
                    <div class="col-span-9">
                      <progress class="progress progress-success w-full" value="0" max="100" data-val="18"></progress>
                    </div>
                    <div class="col-span-1 text-right text-sm font-medium" data-out>18</div>
                  </div>
                  <div class="grid grid-cols-12 gap-3 items-center">
                    <div class="col-span-2 text-sm">Miércoles</div>
                    <div class="col-span-9">
                      <progress class="progress progress-success w-full" value="0" max="100" data-val="9"></progress>
                    </div>
                    <div class="col-span-1 text-right text-sm font-medium" data-out>9</div>
                  </div>
                  <div class="grid grid-cols-12 gap-3 items-center">
                    <div class="col-span-2 text-sm">Jueves</div>
                    <div class="col-span-9">
                      <progress class="progress progress-success w-full" value="0" max="100" data-val="15"></progress>
                    </div>
                    <div class="col-span-1 text-right text-sm font-medium" data-out>15</div>
                  </div>
                  <div class="grid grid-cols-12 gap-3 items-center">
                    <div class="col-span-2 text-sm">Viernes</div>
                    <div class="col-span-9">
                      <progress class="progress progress-success w-full" value="0" max="100" data-val="7"></progress>
                    </div>
                    <div class="col-span-1 text-right text-sm font-medium" data-out>7</div>
                  </div>
                  <div class="grid grid-cols-12 gap-3 items-center">
                    <div class="col-span-2 text-sm">Sábado</div>
                    <div class="col-span-9">
                      <progress class="progress progress-success w-full" value="0" max="100" data-val="5"></progress>
                    </div>
                    <div class="col-span-1 text-right text-sm font-medium" data-out>5</div>
                  </div>
                  <div class="grid grid-cols-12 gap-3 items-center">
                    <div class="col-span-2 text-sm">Domingo</div>
                    <div class="col-span-9">
                      <progress class="progress progress-success w-full" value="0" max="100" data-val="2"></progress>
                    </div>
                    <div class="col-span-1 text-right text-sm font-medium" data-out>2</div>
                  </div>
                </div>

                <div class="mt-3 text-sm opacity-70">Total semanal: <b>68</b></div>
              </div>
            </div>

            <!-- Cierre contable de hoy -->
            <div class="card bg-base-100 shadow">
              <div class="card-body">
                <div class="flex items-center justify-between">
                  <h3 class="card-title">Cierre contable de hoy</h3>
                  <span id="cierreEstado" class="badge">—</span>
                </div>

                <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                  <div>
                    <div class="text-sm opacity-70">Tiempo restante</div>
                    <div id="cierreCountdown" class="text-3xl font-bold tracking-tight">--:--:--</div>
                  </div>
                  <div>
                    <div class="text-sm opacity-70">Hora límite</div>
                    <div id="cierreHora" class="text-xl font-semibold">18:00</div>
                    <div class="text-xs opacity-60" id="cierreFecha">—</div>
                  </div>
                  <div class="text-right">
                    <a id="cierreBtn" class="btn btn-primary" href="/admin/cierre-diario">Cerrar día ahora</a>
                  </div>
                </div>

                <div class="mt-4">
                  <div class="flex justify-between text-xs opacity-70 mb-1">
                    <span>Inicio del día</span>
                    <span>Fin del día</span>
                  </div>
                  <progress id="cierreProgress" class="progress progress-success w-full" value="0" max="100"></progress>
                </div>

                <div id="cierreConfig"
                     data-deadline="2025-10-10T18:00:00"
                     data-open-since="2025-10-10T08:00:00"
                     data-close-url="/admin/cierre-diario">
                </div>
              </div>
            </div>

            <!-- Movimientos recientes -->
            <div class="card bg-base-100 shadow lg:col-span-2">
              <div class="card-body">
                <h3 class="card-title">Movimientos recientes</h3>

                <div class="overflow-x-auto">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Fecha/Hora</th>
                        <th>Partida</th>
                        <th>Cuenta</th>
                        <th class="text-right">Débito</th>
                        <th class="text-right">Crédito</th>
                        <th>Usuario</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr class="hover">
                        <td>2025-10-10 10:42</td>
                        <td><span class="badge badge-ghost">#1251</span></td>
                        <td>1101 - Caja</td>
                        <td class="text-right"><span class="badge badge-success badge-outline">$1,250.00</span></td>
                        <td class="text-right">—</td>
                        <td><span class="badge">maria</span></td>
                      </tr>
                      <tr class="hover">
                        <td>2025-10-10 10:38</td>
                        <td><span class="badge badge-ghost">#1250</span></td>
                        <td>4101 - Ventas</td>
                        <td class="text-right">—</td>
                        <td class="text-right"><span class="badge badge-error badge-outline">$1,250.00</span></td>
                        <td><span class="badge">maria</span></td>
                      </tr>
                      <tr class="hover">
                        <td>2025-10-10 10:15</td>
                        <td><span class="badge badge-ghost">#1249</span></td>
                        <td>1205 - Clientes</td>
                        <td class="text-right">—</td>
                        <td class="text-right"><span class="badge badge-error badge-outline">$300.00</span></td>
                        <td><span class="badge">carlos</span></td>
                      </tr>
                      <tr class="hover">
                        <td>2025-10-10 09:58</td>
                        <td><span class="badge badge-ghost">#1248</span></td>
                        <td>5101 - Compras</td>
                        <td class="text-right"><span class="badge badge-success badge-outline">$800.00</span></td>
                        <td class="text-right">—</td>
                        <td><span class="badge">andrea</span></td>
                      </tr>
                      <tr class="hover">
                        <td>2025-10-10 09:41</td>
                        <td><span class="badge badge-ghost">#1247</span></td>
                        <td>2102 - Proveedores</td>
                        <td class="text-right">—</td>
                        <td class="text-right"><span class="badge badge-error badge-outline">$800.00</span></td>
                        <td><span class="badge">jorge</span></td>
                      </tr>
                    </tbody>
                  </table>
                </div>

              </div>
            </div>

          </div>
          <!-- ====== /FILA VISUAL ====== -->

          <!-- ====== SCRIPTS DE DASHBOARD (ADMIN) ====== -->
          <!-- 1) Auto-% para barras (progress) -->
          <script>
            document.addEventListener('DOMContentLoaded', () => {
              document.querySelectorAll('[data-group]').forEach(group => {
                const bars = group.querySelectorAll('progress[data-val]');
                const values = Array.from(bars).map(b => Number(b.dataset.val) || 0);
                const max = Math.max(1, ...values);
                bars.forEach(b => b.value = Math.round((Number(b.dataset.val) || 0) * 100 / max));
                const totalHolders = group.querySelectorAll('[data-total]');
                if (totalHolders.length && !totalHolders[0].dataset.bound) {
                  const sum = values.reduce((a,b)=>a+b,0);
                  totalHolders.forEach(el => { el.textContent = sum; el.dataset.bound = '1'; });
                }
              });
            });
          </script>

          <!-- 2) Contador de cierre -->
          <script>
            (function(){
              const cfg   = document.getElementById('cierreConfig');
              if(!cfg) return;

              const deadlineISO = cfg.dataset.deadline;
              const openSinceISO= cfg.dataset.openSince;
              const closeUrl    = cfg.dataset.closeUrl || '/admin/cierre-diario';

              const deadline = new Date(deadlineISO);
              const openSince= openSinceISO ? new Date(openSinceISO) : null;

              const elCountdown = document.getElementById('cierreCountdown');
              const elEstado    = document.getElementById('cierreEstado');
              const elHora      = document.getElementById('cierreHora');
              const elFecha     = document.getElementById('cierreFecha');
              const elBtn       = document.getElementById('cierreBtn');
              const elProg      = document.getElementById('cierreProgress');

              elHora.textContent = deadline.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
              elFecha.textContent = deadline.toLocaleDateString();

              function fmt(ms){
                if (ms < 0) ms = 0;
                const s = Math.floor(ms/1000);
                const hh = String(Math.floor(s/3600)).padStart(2,'0');
                const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
                const ss = String(s%60).padStart(2,'0');
                return `${hh}:${mm}:${ss}`;
              }

              function tick(){
                const now = new Date();
                const msLeft = deadline - now;
                elCountdown.textContent = fmt(msLeft);

                const abierto = msLeft > 0;
                elEstado.textContent = abierto ? 'Abierto' : 'Cerrado';
                elEstado.className = 'badge ' + (abierto ? 'badge-success' : 'badge-ghost');

                elBtn.href = closeUrl;
                elBtn.classList.toggle('btn-disabled', !abierto);
                elBtn.toggleAttribute('disabled', !abierto);

                if (openSince && elProg) {
                  const total = deadline - openSince;
                  const trans = Math.min(Math.max(now - openSince, 0), total);
                  const pct = total > 0 ? Math.round((trans/total)*100) : 0;
                  elProg.value = pct;
                }
              }

              tick();
              setInterval(tick, 1000);
            })();
          </script>

          <!-- 3) Reloj (zona horaria El Salvador) -->
          <script>
            (function(){
              const elHora = document.getElementById('reloj-hora');
              const elFecha = document.getElementById('reloj-fecha');
              if(!elHora || !elFecha) return;

              const tz = 'America/El_Salvador';
              const fmtHora  = new Intl.DateTimeFormat('es-SV', {
                hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false, timeZone: tz
              });
              const fmtFecha = new Intl.DateTimeFormat('es-SV', {
                weekday:'long', day:'2-digit', month:'short', year:'numeric', timeZone: tz
              });

              function tick(){
                const now = new Date();
                elHora.textContent  = fmtHora.format(now);
                elFecha.textContent = fmtFecha.format(now);
              }
              tick();
              setInterval(tick, 1000);
            })();
          </script>
          <!-- ====== /SCRIPTS DE DASHBOARD (ADMIN) ====== -->

        </div> <!-- /ADMIN -->

        <!-- DASHBOARD PARA AUDITOR -->
        <div th:if="${usuario.role == 'AUDITOR'}">
          <h2 class="text-2xl font-bold mb-6">Panel de Auditoría</h2>
          
        </div>

        <!-- DASHBOARD PARA CONTADOR -->
        <div th:if="${usuario.role == 'CONTADOR'}">
          <h2 class="text-2xl font-bold mb-6">Panel Contable</h2>
          <!-- ... tu contenido para CONTADOR ... -->
        </div>

      </div> <!-- /p-6 -->

      <h1 th:text="'mi rol actual: ' + ${usuario.role}">test</h1>
    </div>

    <div class="drawer-side">
      <label for="my-drawer-3" aria-label="close sidebar" class="drawer-overlay"></label>

      <ul class="menu bg-base-200 min-h-full w-64 p-3 flex flex-col">
        <li class="mb-2">
          <div class="px-2 py-3">
            <h1 class="text-2xl font-bold leading-tight">SIC</h1>
            <p class="text-xs opacity-70">Sistema Contable</p>
          </div>
        </li>

        <li class="active menu-active">
          <a th:href="@{/dashboard}">Dashboard</a>
        </li>

        <div th:if="${usuario.role == 'ADMIN'}" class="mt-2">
          <li class="menu-title"><span>Administración</span></li>
          <li><a th:href="@{/admin/usuarios}">Gestionar Usuarios</a></li>
          <li><a th:href="@{/admin/libro-diario}">Libro Diario</a></li>
          <li><a th:href="@{/admin/libro-mayor}">Libro Mayor</a></li>
          <li><a th:href="@{/admin/balance-comprobacion}">Balance Comprobación</a></li>
          <li><a th:href="@{/admin/balance-general}">Balance General</a></li>
          <li><a th:href="@{/admin/ver-pdfs}">Ver PDFs</a></li>
          <li><a th:href="@{/admin/configuracion}">Configuración</a></li>
        </div>

        <div th:if="${usuario.role == 'AUDITOR'}" class="mt-2">
          <li class="menu-title"><span>Auditoría</span></li>
          <li><a th:href="@{/auditor/libro-diario}">Libro Diario</a></li>
          <li><a th:href="@{/auditor/libro-mayor}">Libro Mayor</a></li>
          <li><a th:href="@{/auditor/balance-comprobacion}">Balance Comprobación</a></li>
          <li><a th:href="@{/auditor/balance-general}">Balance General</a></li>
          <li><a th:href="@{/auditor/ver-pdfs}">Ver PDFs</a></li>
          <li><a th:href="@{/auditor/configuracion}">Configuración</a></li>
        </div>

        <div th:if="${usuario.role == 'CONTADOR'}" class="mt-2">
          <li class="menu-title"><span>Contabilidad</span></li>
          <li><a th:href="@{/registrar-partida}">Registrar Partida</a></li>
          <li><a th:href="@{/contador/libro-diario}">Libro Diario</a></li>
          <li><a th:href="@{/contador/libro-mayor}">Libro Mayor</a></li>
          <li><a th:href="@{/contador/balance-comprobacion}">Balance Comprobación</a></li>
          <li><a th:href="@{/contador/balance-general}">Balance General</a></li>
          <li><a th:href="@{/contador/subir-pdf}">Subir PDF</a></li>
          <li><a th:href="@{/contador/configuracion}">Configuración</a></li>
        </div>

        <div class="flex-1"></div>

        <li class="mt-2">
          <form th:action="@{/logout}" method="post">
            <button type="submit" class="btn btn-outline btn-error w-full">Cerrar sesión</button>
          </form>
        </li>
      </ul>
    </div>

  </div>

</body>
</html>
